#!/bin/bash -e

if (echo $OSTYPE | grep -q darwin)
then
    LN=gln
    READLINK=greadlink
else
    LN=ln
    READLINK=readlink
fi

DIR=$($READLINK -f $(dirname $0))

# Config and dotfiles
mkdir -p $HOME/.config
ls $DIR/config | xargs -I FILE $LN -sfnT $DIR/config/FILE $HOME/.config/FILE
ls $DIR/dotfiles | xargs -I FILE $LN -sfnT $DIR/dotfiles/FILE $HOME/.FILE
$LN -sfnT $DIR/bin $HOME/bin

# Root shell config
sudo sh -c "$LN -sfnT $DIR/dotfiles/zshrc "'$HOME'"/.zshrc"
sudo sh -c "$LN -sfnT $DIR/dotfiles/zshenv "'$HOME'"/.zshenv"

# Git repositories
submodule () {
    if [ ! -d "$1"/.git ]
    then
        # Ignore the config file as the SSH keys might not yet be there
        HOME=/dev/null XDG_CONFIG_HOME=/dev/null git clone "$2" "$1"
    fi
}

submodule $HOME/.emacs.d https://github.com/syl20bnr/spacemacs
submodule $HOME/.vim https://github.com/koterpillar/vim.git

if (echo $OSTYPE | grep -q linux)
then
    # xdg-mime ignores $XDG_CONFIG_HOME/mimeapps.list
    mkdir -p $HOME/.local/share/applications
    $LN -sf $HOME/.config/mimeapps.list $HOME/.local/share/applications/mimeapps.list
fi
