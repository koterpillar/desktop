#!/bin/bash

set -e

if (echo $OSTYPE | grep -q darwin)
then
    LN=gln
    READLINK=greadlink
    DHALL_OS='let OS = ./common/OS.dhall in OS.Macos'
else
    LN=ln
    READLINK=readlink
    DHALL_OS='let OS = ./common/OS.dhall in OS.Linux'
fi
export DHALL_OS

DIR=$($READLINK -f $(dirname $0))

# Config and dotfiles
dhall-to-json < config/karabiner/karabiner.dhall > config/karabiner/karabiner.json
dhall-to-yaml-ng < config/alacritty/alacritty.dhall > config/alacritty/alacritty.yml
if [ -d $HOME/.vim/.git ]
then
    rm -rf $HOME/.vim
fi
mkdir -p $HOME/.config
ls $DIR/config | xargs -I FILE $LN -sfnT $DIR/config/FILE $HOME/.config/FILE
ls $DIR/dotfiles | xargs -I FILE $LN -sfnT $DIR/dotfiles/FILE $HOME/.FILE
$LN -sfnT $DIR/bin $HOME/bin

# Root shell config
for FILE in dircolors vim zshrc zshenv
do
    sudo sh -c "$LN -sfnT $DIR/dotfiles/$FILE ~root/.$FILE"
done

# Git repositories
submodule () {
    if [ ! -d "$1"/.git ]
    then
        # Ignore the config file as the SSH keys might not yet be there
        HOME=/dev/null XDG_CONFIG_HOME=/dev/null git clone "$2" "$1"
    fi
}

submodule $HOME/.jenv https://github.com/gcuisinier/jenv.git

