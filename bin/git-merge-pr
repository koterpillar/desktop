#!/usr/bin/env python
"""
Merge the current pull request and remove the branch.
"""

from __future__ import print_function

import argparse
import subprocess
import sys


def git(*args):
    """Call git in a subprocess."""

    return subprocess.check_output(('git',) + args).decode()


def main():
    """Main entry point."""

    parser = argparse.ArgumentParser(
        description="Merge the current pull request and remove the branch",
    )
    parser.add_argument('branch', nargs='?', help="The branch to merge")
    parser.add_argument('--to', help="Branch to merge to")
    parser.add_argument('--master', action='store_true',
                        help="Merge into master instead of develop")

    args = parser.parse_args()

    if args.to:
        base = args.to
    elif args.master:
        base = 'master'
    else:
        try:
            git('show-ref', 'develop')
            base = 'develop'
        except subprocess.CalledProcessError:
            base = 'master'

    current = args.branch or \
        git('rev-parse', '--abbrev-ref', 'HEAD').strip()

    if current == base:
        print("Cannot merge the {0} branch to itself.".format(current),
              file=sys.stderr)
        return 1

    if current in ('master', 'develop'):
        print("Cannot merge the {0} branch.".format(current),
                file=sys.stderr)
        return 1

    try:
        git('checkout', base)
        git('fetch')
        git('reset', '--hard', 'origin/{0}'.format(base))
        git('merge', '--no-ff', '--no-edit', current)
        git('push')
        try:
            git('push', 'origin', '--delete', current)
        except subprocess.CalledProcessError:
            pass
        git('branch', '-d', current)
    except (subprocess.CalledProcessError, KeyboardInterrupt):
        try:
            git('checkout', current)
        except subprocess.CalledProcessError:
            pass
        raise

    return 0


if __name__ == '__main__':
    sys.exit(main())
