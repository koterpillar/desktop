#!/bin/sh -e

if [ "$1" == "--delay" ]
then
    # Ensure only one copy is running
    LOCK_DIR=$XDG_RUNTIME_DIR/fix-env.lock
    if mkdir $LOCK_DIR 2>/dev/null
    then
        trap 'rmdir "$LOCK_DIR"; exit $?' EXIT
        sleep 3
    else
        exit
    fi
fi

setxkbmap -option altwin:swap_alt_win

has_connection () {
    nmcli --terse --fields name connection show --active | grep -v docker0 | grep -v "Wired Connection" | sha1sum | grep -q $1
}

has_monitor () {
    xrandr | grep -q "^$1 connected"
}

DPI=96

xrandr_dpi () {
    xrandr --dpi $DPI "$@"
}

case $(hostname) in
    taohua)
        SOUNDCARD=alsa_card.pci-0000_00_1f.3
        SOUND_OUTPUT=alsa_output.pci-0000_00_1f.3

        # Sometimes PulseAudio gets stuck on "null sink", changing the
        # output profile manually fixes it
        pactl set-card-profile $SOUNDCARD output:analog-stereo

        xrandr_dpi --auto
        if has_monitor HDMI-1
        then
            xrandr_dpi --output HDMI-1 --primary --above eDP-1 --auto
            pactl set-card-profile $SOUNDCARD output:hdmi-stereo+input:analog-stereo
            pactl set-default-sink $SOUND_OUTPUT.hdmi-stereo
        else
            pactl set-card-profile $SOUNDCARD output:analog-stereo+input:analog-stereo
            pactl set-default-sink $SOUND_OUTPUT.analog-stereo
        fi
    ;;
    yulan)
        DPI=125
        if has_monitor HDMI-1
        then
      xrandr_dpi --auto
      xrandr_dpi --output HDMI-1 --primary --above eDP-1 --auto
        elif has_monitor DP-1
        then
              if has_connection 503314a033141b4654c78cca5d4bfe59fcbe6dc0 || \
                      has_connection 6c3601e50a2c5d2bc0ae572fb4d5cc8431d7d9ec || \
                      has_connection ba43afe9d58caa2ca2b415be79032b7b7e7aabfb
              then
            DPI=96
            xrandr_dpi --auto
                    xrandr_dpi --output DP-1 --primary --left-of eDP-1 --auto
                    xrandr_dpi --output eDP-1 --pos 2560x600
              else
            DPI=96
            xrandr_dpi --auto
                    xrandr_dpi --output DP-1 --primary --above eDP-1 --auto
              fi
        elif has_monitor DP-1-8
        then
            if has_connection 503314a033141b4654c78cca5d4bfe59fcbe6dc0 || \
                    has_connection 6c3601e50a2c5d2bc0ae572fb4d5cc8431d7d9ec || \
                    has_connection ba43afe9d58caa2ca2b415be79032b7b7e7aabfb
            then
        DPI=96
        xrandr_dpi --auto
                xrandr_dpi --output DP-1-8 --primary --left-of eDP-1 --auto
                xrandr_dpi --output eDP-1 --pos 2560x600
            else
        DPI=96
        xrandr_dpi --auto
                xrandr_dpi --output DP-1-8 --primary --above eDP-1 --auto
            fi
        else
      xrandr_dpi --auto
        fi

        if has_connection 503314a033141b4654c78cca5d4bfe59fcbe6dc0 || \
                has_connection 6c3601e50a2c5d2bc0ae572fb4d5cc8431d7d9ec || \
                has_connection ba43afe9d58caa2ca2b415be79032b7b7e7aabfb || \
                has_connection 81340f1c782c190b9c45e8967a63581f0451fb01
        then
            pactl set-sink-mute alsa_output.pci-0000_00_1f.3.analog-stereo 1
        fi
    ;;
esac

if [ -f ~/.fehbg ]
then
    . ~/.fehbg
fi
