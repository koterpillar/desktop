#!/usr/bin/env bash

set -e

if [ "$#" -ne 2 ]
then
    echo "Usage: git lfs-cat-file revision path" >&2
    exit 1
fi

REVISION=$1
FILE=$2

# Example output of git cat-file blob with an LFS file:
# version https://git-lfs.github.com/spec/v1
# oid sha256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# size XXXXXXXX

LFS_FILE=$(git cat-file blob $REVISION:$FILE)

if ! echo $LFS_FILE | grep -q "version https://git-lfs.github.com/spec/v1"
then
    echo "$FILE is not an LFS file." >&2
    exit 1
fi

OID=$(echo $LFS_FILE | grep oid | awk '{ print $2 }' | awk -F : '{print $2}')

GIT_DIR=$(git rev-parse --git-dir)
OBJECT_PATH=$GIT_DIR/lfs/objects/${OID:0:2}/${OID:2:2}/$OID

cat $OBJECT_PATH