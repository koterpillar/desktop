#!/bin/bash

set -e

DIR=$(readlink -f $(dirname $0))

# Packages
# TODO: obnam
sudo dnf copr enable -y pschyska/alacritty
sudo dnf copr enable -y mikelo2/keeweb
sudo dnf install https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm
sudo dnf install https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
sudo dnf install -y \
  alacritty \
  curl \
  docker \
  ghc \
  git \
  git-lfs \
  hlint \
  htop \
  jq \
  lsof \
  KeeWeb \
  meld \
  moreutils \
  mosh \
  mozilla-fira-mono-fonts \
  nmap \
  nodejs \
  npm \
  pwgen \
  python \
  python3 \
  ripgrep \
  rlwrap \
  rsync \
  snapd \
  strace \
  tcpdump \
  tig \
  tmux \
  util-linux-user \
  vim \
  vlc \
  wget \
  youtube-dl \
  zsh \
  && true
sudo ln -sf /var/lib/snapd/snap /snap
curl -sSL https://get.haskellstack.org/ | sh

# Shell
if [ $(getent passwd $USER | cut -d: -f7) != "/bin/zsh" ]
then
  chsh -s /bin/zsh
fi

$DIR/makelinks

# Systemd
sudo systemctl enable --no-reload \
  docker \
  sshd \
  && true
# Ignore reload errors if running in chroot
sudo systemctl daemon-reload || true

# Inotify limits
echo 'fs.inotify.max_user_watches = 524288' | sudo tee /etc/sysctl.d/50-inotify.conf
sudo sysctl -p --system
