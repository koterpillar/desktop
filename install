#!/bin/bash
#shellcheck disable=SC2093

set -euo pipefail

source "$(dirname "$0")/functions.sh"

venv

exec python "$DIR/install.py" "$@"

INSTALL_DESKTOP=true
if [ "${1-}" == "--no-desktop" ]
then
  INSTALL_DESKTOP=
  shift
fi

# Packages
case "$OS" in
  linux)
    if [ -n "$INSTALL_DESKTOP" ]
    then
      FEDORA_VERSION=$(rpm -E %fedora)
      sudo dnf -y install "https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-${FEDORA_VERSION}.noarch.rpm"
      sudo dnf -y install "https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-${FEDORA_VERSION}.noarch.rpm"

      sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
      sudo sh -c 'echo -e "[code]\nname=Visual Studio Code\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/vscode.repo'
      sudo dnf install -y code

      # Systemd
      sudo systemctl daemon-reload || true
      sudo systemctl enable --no-reload \
        docker \
        sshd \
        && true
      sudo systemctl daemon-reload || true
    fi
    ;;
esac

# Shell
case "$OS" in
  linux)
    CURRENT_SHELL="$(getent passwd "$USER" | cut -d: -f7)"
    DESIRED_SHELL="/bin/zsh"
    ;;
  macos)
    CURRENT_SHELL="$(dscl . -read ~/ UserShell | sed 's/UserShell: //')"
    DESIRED_SHELL="/usr/local/bin/zsh"
    ;;
esac
if [ "$CURRENT_SHELL" != "$DESIRED_SHELL" ]
then
  if ! grep -qx "$DESIRED_SHELL" /etc/shells
  then
    echo "$DESIRED_SHELL" | sudo tee -a /etc/shells >/dev/null
  fi
  chsh -s "$DESIRED_SHELL"
fi

# User configuration
export PATH="$HOME/.local/bin:$PATH"
"$DIR"/makelinks
