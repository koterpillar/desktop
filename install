#!/bin/bash

set -euo pipefail

# Prerequisites
case "$OSTYPE" in
  darwin*)
    if ! command -v brew >/dev/null 2>&1
    then
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    brew install python3
  ;;
  linux*)
    DISTRO=$(cat /etc/os-release | grep '^ID=' | cut -d = -f 2)
    case $DISTRO in
      debian)
        sudo apt install --yes python3{,-{pip,venv}}
        ;;
    esac
esac

HERE=$(dirname "$0")

PYTHON_ENV="$HERE/python_env"
if ! [ -d "$PYTHON_ENV" ]; then python3 -m venv "$PYTHON_ENV"; fi
"$PYTHON_ENV/bin/pip" install -r "$HERE/requirements.txt"

exec "$PYTHON_ENV/bin/python" "$HERE/install.py" "$@"

source $(dirname $0)/functions.sh

INSTALL_DESKTOP=true
if [ "${1-}" == "--no-desktop" ]
then
  INSTALL_DESKTOP=
  shift
fi

github_release_url() {
  REPO="$1"
  START="$2"
  END="$3"

  curl -sSL https://api.github.com/repos/$REPO/releases/latest | jq -r '.assets[]|select(.name|startswith("'$START'"))|select(.name|endswith("'$END'")).browser_download_url'
}

# Packages
case "$OS" in
  linux)
    NVIM=$(mktemp)
    curl -sSL $(github_release_url neovim/neovim nvim appimage) -o "$NVIM"
    sudo mv "$NVIM" /usr/local/bin/nvim
    sudo chmod +x /usr/local/bin/nvim
    rm -f "$NVIM"

    if [ -n "$INSTALL_DESKTOP" ]
    then
      FEDORA_VERSION=$(rpm -E %fedora)
      sudo dnf -y install https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-${FEDORA_VERSION}.noarch.rpm
      sudo dnf -y install https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-${FEDORA_VERSION}.noarch.rpm
      sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
      sudo sh -c 'echo -e "[code]\nname=Visual Studio Code\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/vscode.repo'
      sudo dnf config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
      sudo dnf install -y \
        code \
        docker \
        gh \
        hlint \
        tcpdump \
        ;

      # Systemd
      sudo systemctl daemon-reload || true
      sudo systemctl enable --no-reload \
        docker \
        sshd \
        && true
          sudo systemctl daemon-reload || true
    fi
    ;;
  macos)
    brew install \
      homebrew/cask/docker \
      shellcheck \
      shfmt \
      visual-studio-code \
      && true
    ;;
esac

# Shell
case "$OS" in
  linux)
    CURRENT_SHELL="$(getent passwd $USER | cut -d: -f7)"
    DESIRED_SHELL="/bin/zsh"
    ;;
  macos)
    CURRENT_SHELL="$(dscl . -read ~/ UserShell | sed 's/UserShell: //')"
    DESIRED_SHELL="/usr/local/bin/zsh"
    ;;
esac
if [ "$CURRENT_SHELL" != "$DESIRED_SHELL" ]
then
  if ! grep -qx "$DESIRED_SHELL" /etc/shells
  then
    echo "$DESIRED_SHELL" | sudo tee -a /etc/shells >/dev/null
  fi
  chsh -s "$DESIRED_SHELL"
fi

# User packages
export PATH="$HOME/.local/bin:$PATH"

if [ "$OS" == "linux" ] && [ -n "$INSTALL_DESKTOP" ]
then
  # Kitty
  KITTY=$HOME/.local/kitty.app
  mkdir -p $KITTY
  curl -sSL $(github_release_url kovidgoyal/kitty kitty x86_64.txz) | tar -J -x -C $KITTY
  ln -sfnT $KITTY/bin/kitty $HOME/.local/bin/kitty
  cat $KITTY/share/applications/kitty.desktop \
    | sed "s|Icon=kitty|Icon=/home/$USER/.local/kitty.app/share/icons/hicolor/256x256/apps/kitty.png|g" \
    > $HOME/.local/share/applications/kitty.desktop
fi

# User configuration
$DIR/makelinks
