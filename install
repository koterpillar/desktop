#!/bin/bash

set -euo pipefail

/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/koterpillar/mybox/main/bootstrap)"

# Prerequisites
case "$OSTYPE" in
  darwin*)
    OS=macos
  ;;
  linux*)
    OS=linux
    DISTRO=$(grep '^ID=' /etc/os-release | cut -d = -f 2)

    case $DISTRO in
      fedora)
        FEDORA_VERSION=$(rpm -E %fedora)
        for PART in free nonfree
        do
          if ! (rpm -q rpmfusion-$PART-release 2>/dev/null || true) | grep -q "$FEDORA_VERSION" >/dev/null
          then
            sudo dnf -y install "https://download1.rpmfusion.org/$PART/fedora/rpmfusion-$PART-release-${FEDORA_VERSION}.noarch.rpm"
          fi
        done

        if ! rpm -q gpg-pubkey --qf '%{NAME}-%{VERSION}-%{RELEASE}\t%{SUMMARY}\n' | grep -q Microsoft >/dev/null
        then
          sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
        fi

        if ! [ -f /etc/yum.repos.d/vscode.repo ]
        then
          sudo cp repositories/vscode.repo /etc/yum.repos.d/vscode.repo
        fi

        ;;
    esac
esac

mybox "$@"

export OS

# Shell
case "$OS" in
  linux)
    CURRENT_SHELL="$(getent passwd "$USER" | cut -d: -f7)"
    DESIRED_SHELL="/bin/zsh"
    ;;
  macos)
    CURRENT_SHELL="$(dscl . -read ~/ UserShell | sed 's/UserShell: //')"
    DESIRED_SHELL="/usr/local/bin/zsh"
    ;;
esac
if [ "$CURRENT_SHELL" != "$DESIRED_SHELL" ]
then
  if ! grep -qx "$DESIRED_SHELL" /etc/shells
  then
    echo "$DESIRED_SHELL" | sudo tee -a /etc/shells >/dev/null
  fi
  chsh -s "$DESIRED_SHELL"
fi

# User configuration
export PATH="$HOME/.local/bin:$PATH"

# Config interpolation
if [ "$OS" = "macos" ]
then
    DHALL_OS='let OS = ./common/OS.dhall in OS.Macos'
else
    DHALL_OS='let OS = ./common/OS.dhall in OS.Linux'
fi
export DHALL_OS

dhall-to-json < config/karabiner/karabiner.dhall > config/karabiner/karabiner.json
