#!/bin/bash -e

INSTALL='sudo pacman -S --needed --noconfirm'

DIR=$(readlink -f $(dirname $0))

# Pacman configuration
PACMAN_CONF=/etc/pacman.conf
if ! diff -q $PACMAN_CONF $DIR/etc/pacman.conf >/dev/null
then
	sudo install $DIR/etc/pacman.conf $PACMAN_CONF

	sudo rm -rf /etc/pacman.d/gnupg
	sudo pacman-key --init
	sudo pacman-key --populate archlinux

	sudo pacman -Sy
fi

# Install pacaur from AUR manually
if ! which pacaur >/dev/null 2>&1
then
	function aur_install () {
		PACKAGE=$1
		TMPDIR=$(mktemp -d)
		trap "rm -rf $TMPDIR" EXIT
		curl -s https://aur.archlinux.org/cgit/aur.git/snapshot/$PACKAGE.tar.gz | \
			tar xz -C $TMPDIR
		pushd $TMPDIR/$PACKAGE >/dev/null
		makepkg
		sudo pacman -U --noconfirm $PACKAGE-*.pkg.tar.xz
		popd >/dev/null
	}

	$INSTALL wget base-devel abs

	$INSTALL expac yajl
	gpg --recv-keys 1EB2638FF56C0C53  # pacaur/cower key
	aur_install cower
	aur_install pacaur
fi

INSTALL='pacaur -S --needed --noconfirm'
AUR_INSTALL='pacaur -y --needed --noconfirm'
STACK_INSTALL='stack install'
PIP_INSTALL='pip install --user --upgrade'

# Packages
# Files in packages/ may contain Bash brace expansions

$INSTALL $(bash -c "echo $(echo $(cat $DIR/packages/* | grep -v '^[a-z]\+:'))")

# gcc-multilib conflicts with gcc
yes | sudo pacman -S --needed gcc-multilib
$AUR_INSTALL $(bash -c "echo $(echo $(cat $DIR/packages/* | sed '/^aur:/!d;s/^aur://g'))")

ln -sfnT $DIR/dotfiles/stack $HOME/.stack
stack setup
# gi-* depends on haskell-gi but doesn't list it as a dependency
stack build haskell-gi
$STACK_INSTALL $(bash -c "echo $(echo $(cat $DIR/packages/* | sed '/^stack:/!d;s/^stack://g'))")

$INSTALL python-pip
$PIP_INSTALL $(bash -c "echo $(echo $(cat $DIR/packages/* | sed '/^pip:/!d;s/^pip://g'))")

# Shell
if [ $(getent passwd $USER | cut -d: -f7) != "/bin/zsh" ]
then
	chsh -s /bin/zsh
fi

# System config
sudo install $DIR/etc/default/tlp /etc/default/tlp

# Fontconfig
# https://gist.github.com/cryzed/4f64bb79e80d619866ee0b18ba2d32fc
sudo ln -sfn /etc/fonts/conf.avail/10-hinting-slight.conf /etc/fonts/conf.d/
sudo ln -sfn /etc/fonts/conf.avail/10-sub-pixel-rgb.conf /etc/fonts/conf.d/
sudo ln -sfn /etc/fonts/conf.avail/11-lcdfilter-default.conf /etc/fonts/conf.d/
sudo ln -sfn /etc/fonts/conf.avail/30-infinality-aliases.conf /etc/fonts/conf.d/

$DIR/makelinks

# Systemd
ls config/systemd/user/*.service | xargs -n 1 basename | xargs systemctl --user enable
sudo systemctl enable \
	docker \
	lightdm \
	NetworkManager \
	nfs-client.target \
	rpcbind \
	sshd \
	tlp \
	tlp-sleep \
	&& true
sudo systemctl disable systemd-rfkill
timedatectl set-ntp true

# XMonad and Tianbar config
$HOME/.local/bin/xmonad --recompile
cd $DIR/config/tianbar
npm install
./node_modules/.bin/bower install
cd - >/dev/null

for conf in $DIR/dconf/*.dconf
do
	confpath=$(echo $conf | sed -E 's!.+/!!;s!\.!/!g;s!dconf$!!;s!^!/!')
	dconf load $confpath < $conf
done
