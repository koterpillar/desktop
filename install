#!/bin/bash -e

INSTALL='sudo pacman -S --needed --noconfirm'

DIR=$(readlink -f $(dirname $0))

. $DIR/functions.sh

# Pacman configuration
PACMAN_CONF=/etc/pacman.conf
if ! diff -q $PACMAN_CONF $DIR/etc/pacman.conf >/dev/null
then
  sudo install $DIR/etc/pacman.conf $PACMAN_CONF

  sudo rm -rf /etc/pacman.d/gnupg
  sudo pacman-key --init
  sudo pacman-key --populate archlinux

  sudo pacman -Sy
fi

# Install aura from AUR manually
if ! which aura >/dev/null 2>&1
then
  $INSTALL wget base-devel

  aur_install aura-bin
fi

INSTALL='sudo pacman -S --needed --noconfirm'
AUR_INSTALL='sudo aura -A --needed --noconfirm'

# Packages
$INSTALL $(cat $DIR/packages/* | grep -v '^[a-z]\+:')
$AUR_INSTALL $(cat $DIR/packages/* | sed '/^aur:/!d;s/^aur://g')

# Shell
if [ $(getent passwd $USER | cut -d: -f7) != "/bin/zsh" ]
then
  chsh -s /bin/zsh
fi

$DIR/makelinks

# Systemd
sudo systemctl enable --no-reload \
  docker \
  sshd \
  && true
# Ignore reload errors if running in chroot
sudo systemctl daemon-reload || true
